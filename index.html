<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Data - Dashboard</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div id="app" class="container mx-auto p-4">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-blue-800">Dashboard de Despesas ANS</h1>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Estatísticas -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4">Resumo Geral</h2>
                <div v-if="stats">
                    <p class="text-gray-600">Total de Despesas: <span class="font-bold text-green-600">R$ {{ stats.total_despesas?.toLocaleString() }}</span></p>
                    <p class="text-gray-600">Média por Registro: <span class="font-bold text-blue-600">R$ {{ stats.media_despesas?.toLocaleString() }}</span></p>
                </div>
            </div>

            <!-- Gráfico -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4">Distribuição por UF</h2>
                <canvas id="ufChart"></canvas>
            </div>
        </div>

        <!-- Tabela de Operadoras -->
        <div class="bg-white p-6 rounded-lg shadow">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Operadoras</h2>
                <input v-model="search" @input="fetchOperadoras" type="text" placeholder="Buscar por Nome ou CNPJ..." class="border p-2 rounded w-64">
            </div>
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="p-3 border">CNPJ</th>
                        <th class="p-3 border">Razão Social</th>
                        <th class="p-3 border">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="op in operadoras" :key="op.CNPJ" class="hover:bg-gray-50">
                        <td class="p-3 border">{{ op.CNPJ }}</td>
                        <td class="p-3 border">{{ op.RazaoSocial }}</td>
                        <td class="p-3 border">
                            <button @click="viewDetails(op.CNPJ)" class="text-blue-600 hover:underline">Ver Detalhes</button>
                        </td>
                    </tr>
                </tbody>
            </table>
            <div class="mt-4 flex justify-center gap-2">
                <button @click="changePage(-1)" :disabled="page === 1" class="px-4 py-2 bg-blue-500 text-white rounded disabled:bg-gray-300">Anterior</button>
                <span class="py-2">Página {{ page }}</span>
                <button @click="changePage(1)" :disabled="operadoras.length < limit" class="px-4 py-2 bg-blue-500 text-white rounded disabled:bg-gray-300">Próxima</button>
            </div>
        </div>

        <!-- Modal de Detalhes -->
        <div v-if="selectedOp" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4" @click="closeModal">
            <div class="bg-white rounded-lg max-w-2xl w-full max-h-[80vh] overflow-y-auto" @click.stop>
                <div class="flex items-center justify-between p-4 border-b">
                    <h2 class="text-2xl font-bold">{{ selectedOp.RazaoSocial }}</h2>
                    <button @click="closeModal" class="px-3 py-1 bg-red-500 text-white rounded">Fechar</button>
                </div>
                <div class="p-6">
                    <p class="mb-4"><strong>CNPJ:</strong> {{ selectedOp.CNPJ }}</p>
                    <h3 class="font-semibold mb-2">Histórico de Despesas:</h3>
                    <ul class="mb-2">
                        <li v-for="d in history" :key="d.Trimestre + d.Ano" class="border-b py-2">
                            {{ formatDateFromQuarter(d.Trimestre, d.Ano) }}: R$ {{ d.ValorDespesas.toLocaleString() }}
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;

        createApp({
            setup() {
                const operadoras = ref([]);
                const stats = ref(null);
                const search = ref('');
                const page = ref(1);
                const limit = 5;
                const selectedOp = ref(null);
                const history = ref([]);
                let chart = null;

                const fetchOperadoras = async () => {
                    const res = await fetch(`http://localhost:8000/api/operadoras?page=${page.value}&limit=${limit}&search=${search.value}`);
                    const json = await res.json();
                    operadoras.value = json.data;
                };

                const fetchStats = async () => {
                    const res = await fetch('http://localhost:8000/api/estatisticas');
                    stats.value = await res.json();
                    renderChart();
                };

                const renderChart = () => {
                    if (!stats.value || !stats.value.distribuicao_uf) return;
                    const ctx = document.getElementById('ufChart').getContext('2d');
                    if (chart) chart.destroy();
                    chart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(stats.value.distribuicao_uf),
                            datasets: [{
                                label: 'Total de Despesas por UF',
                                data: Object.values(stats.value.distribuicao_uf),
                                backgroundColor: 'rgba(54, 162, 235, 0.5)'
                            }]
                        }
                    });
                };

                const viewDetails = async (cnpj) => {
                    const res = await fetch(`http://localhost:8000/api/operadoras/${cnpj}`);
                    selectedOp.value = await res.json();
                    const resH = await fetch(`http://localhost:8000/api/operadoras/${cnpj}/despesas`);
                    const raw = await resH.json();
                    const mapTri = { '1T': 3, '2T': 6, '3T': 9, '4T': 12 };
                    const sorted = raw.slice().sort((a,b) => {
                        const ma = (a.Ano || 0) * 100 + (mapTri[a.Trimestre] || 0);
                        const mb = (b.Ano || 0) * 100 + (mapTri[b.Trimestre] || 0);
                        return mb - ma;
                    });
                    history.value = sorted.slice(0, 20);
                };
                
                const formatDateFromQuarter = (tri, ano) => {
                    const endDay = { '1T': '03-31', '2T': '06-30', '3T': '09-30', '4T': '12-31' }[tri] || '12-31';
                    const y = String(ano || '').padStart(4, '0');
                    return `${y}-${endDay}`;
                };
                
                const closeModal = () => { selectedOp.value = null; };

                const changePage = (delta) => {
                    page.value += delta;
                    fetchOperadoras();
                };

                onMounted(() => {
                    fetchOperadoras();
                    fetchStats();
                    window.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape') closeModal();
                    });
                });

                return { operadoras, stats, search, page, limit, selectedOp, history, fetchOperadoras, viewDetails, changePage, closeModal, formatDateFromQuarter };
            }
        }).mount('#app');
    </script>
</body>
</html>
